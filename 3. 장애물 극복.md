# 0. 장애물 파트

#### 목차

**[0. 장애물 파트](#0-------)**

    - [목차](#--)

<br>

**[1. 장애물 분석 연구](#1----------)**

   - [단일 방식](#-----)
   - [복합 방식](#-----)
   - [다중 방식](#-----)

<br>

**[2. 도로 정보를 2차원 map으로 표현하기](#2--------2---map-------)**

   - [1. 기본설계 - 기본 도로 형태 반영을 위한 준비](#1--------------------------)
   - [2. 중앙선 점 좌표 구하기](#2-------------)
   - [3. 중앙선 점을 어떤 방식으로 좌표로 표현할 수 있는가?](#2------------------------------)
   - [4. 도로 정보 및 장애물 표현하기](#3-----------------)

<br>

**[3. 2차원 MAP 기반, 장애물 극복 경로 찾기](#3-2---map-----------------)**

   - [1차 시도 : 장애물 기반으로, 가능한 경로 수집](#1--------------------------)
   - [2차 시도 : 최소 각 경로 찾기](#2-----------------)
   - [이슈 1 : 점으로 표현된 장애물 정보는 실제 크기를 반영하는가 ?](#---1---------------------------------)
   - [이슈 2 : 차량각도가 항상 전방 수직으로 표현되는게 맞는가 ?](#---2-------------------------------)

<br>

**[4. 발생한 치명적인 문제와 해결방안](#4------------------)**

   - [받아오는 API 값이 튄다.](#-----api------)
   - [도로정보가 곡선일때, 왜곡된다.](#----------------)

<br>

**[5. 새로운 접근방법 : to_middle 기반](#5------------to-middle---)**

<br>

<br>

# 1. 장애물 분석 연구 

**주행 코스에는 여러가지 장애물들이 펼쳐저 있는데, 크게 종류는 단일, 복합, 다중 3가지 이다.**

**이번 프로젝트를 진행하면서 매우 다양한 어려움을 만났다. 그 어려움들을 극복한 방식과**

**연구결과 및 접근방식을 소개하고자 한다.**

<br>

<br>

#### 단일 방식

![KakaoTalk_20220821_160205917](https://user-images.githubusercontent.com/89068148/185780140-0e1514f1-20c2-4d88-9ec1-ecaeeccc928f.jpg)

가장 흔한 방식의 장애물, 전체 장애물 중 60%을 차지함.

이 경우, 차량 주행 운신의 폭이 넓고, 가능한 경우의 수가 많기 때문에 쉽게 극복 가능

<br>

#### 복합 방식

![KakaoTalk_20220821_160205917](https://user-images.githubusercontent.com/89068148/185780199-c05f9e1b-5dd7-420b-831a-07e73ad4f16b.jpg)

단순히 장애물의 갯수가 늘어난 방식으로, 차량이 지나갈 수 있는 경로의 가짓수가 줄어들 뿐, 

극복 자체는 쉬운 편

<br>

![KakaoTalk_20220821_160205917](https://user-images.githubusercontent.com/89068148/185780240-c1b29a12-1e77-4343-997f-1e8877c4ed23.jpg)

위의 경우처럼 장애물의 갯수가 늘어난 방식이나, 극복 가능한 경우를 1가지로 제한한 경우로, 
경로 분석을 통해 가능한 경로 1지점을 찾아내야 함.

<br>

<br>

#### 다중 방식

![KakaoTalk_20220821_160205917](https://user-images.githubusercontent.com/89068148/185780266-66e8bebd-f7a8-4ced-a4c9-6e1c77d34c7d.jpg)

<br>

<br>

# 2. 도로 정보를 2차원 map으로 표현하기

<br>

#### 1. 기본설계 - 기본 도로 형태 반영을 위한 준비

```
도로 폭 : 중앙선 점 기준으로 좌우 일정 m 씩 떨어진 형태 (주행코스 별 상이)
         여기선 임의로 10m 로 표시
```

<br>![KakaoTalk_20220821_180157534](https://user-images.githubusercontent.com/89068148/185783791-824effb9-69c4-4632-a575-d1be8b5707d5.jpg)

도로의 중앙선의 점들의 좌표를 구할 수 있다면, 그림처럼 중앙좌표(a,b,c,d)를 기준으로 

좌우로 도로폭(10m) 의 절반(5m)씩 뻗어 나가면 도로의 형태를 그릴 수 있다.

그림의 경우로 보자면, 시뮬레이터에서 api로 제공하는 정보들을 이용하여,  중앙선의 점들의

좌표를 가져온다.

<br>

![KakaoTalk_20220821_162832831_07](https://user-images.githubusercontent.com/89068148/185783950-c687ba52-f11c-47e3-8514-5f0b3adf09c3.jpg)

2차원 배열을 MAP이라고 할때,

각 원소는 1m의 정사각형을 나타낸다.

따라서 각 중앙점 a, b, c, d으로부터 좌우 5칸은 도로의 좌우 간격이 각각 5m임을 표현한다.

<br>

![KakaoTalk_20220821_162832831_07](https://user-images.githubusercontent.com/89068148/185784183-dcaaab54-8819-45d3-85ce-d377a2e7250d.jpg)

예시로 위의 그림에서 차량의 중앙점은 `MAP[11][5]` 으로 나타낼 수 있다.

<br>

<br>

#### 2. 중앙선 점 좌표 구하기

그렇다면, 도로의 중앙점의 좌표를 어떻게 받아 올 수 있을까?

장애물, 도로폭 등 모든 정보가 그 지점들을 기준으로 펼쳐지기 때문에,

결국엔 2차원 배열형태의 MAP으로 표현하기 위해선 중앙선 위의 점들인 way_points의 정확한

좌표정보가 있어야 가능했다.



사용된 api 정보는 다음과 같다.

**to_middle 과 moving_angle**

![KakaoTalk_20220821_185319378](https://user-images.githubusercontent.com/89068148/185785566-b713130a-b488-4014-a4aa-1e0fc6dff9fe.jpg)

`to_middle` 의 경우 내차의 중심점이 도로 중앙선에서 수직으로 떨어진 거리이다.

`moving_angle` 은 현재 차량이 위치한 지점에서 가장 가까운 지점의 중앙선과 얼마나 각도가 차이나는지 이다.

​                            왼쪽방향일 경우, 음수 반대는 양수의 값을 가진다.

<br>

**track_forward_angles**

![KakaoTalk_20220821_191142370](https://user-images.githubusercontent.com/89068148/185786202-8da22a5e-4c8a-4728-985f-110f1c196b43.jpg)

현재 차량 위치 기준, 전방의 10개 구간에 대한 각도 정보
구간은 10m, 

양수일 경우, 현재 차량위치에서 오른쪽으로 기우는 도로
음수일 경우, 현재 기준으로 왼쪽으로 기우는 도로의 형태를 가진다.

다시말해 각도의 차이가 급격히 커질수록 도로가 급격히 휘어지는 형태이다.

<br>

**distance_to_way_points**

![KakaoTalk_20220821_185406830](https://user-images.githubusercontent.com/89068148/185785567-b9f39223-c731-4743-a927-5ddfc6e6e680.jpg)

way-points는 차량이 위치한 지점에서 전방 10m 간격으로 존재하는 중앙선 위의 점이다.
현재 차량에서 해당 점들과의 직선거리 정보를 가진다.

이때 10m 구간들은 아래처럼 정확한 직선의 형태로 받아온다고 가정하고 진행했다.

![KakaoTalk_20220821_192810555](https://user-images.githubusercontent.com/89068148/185786768-85c7843d-a7b6-47ff-8f80-7050696eb8df.jpg)

다시말해, 곡선의 형태로 곡선의 길이가 아닌, 위치 간의 직선거리이다. 

그러나, 이 가정은 **후에 치명적인 오차를 발생시키는 핵심 원인**이 되었다.

그 내용은 뒤에 다시 설명할 예정이다.

<br>

**생각해볼 점)  api 데이터, 정확한 분석의 중요성**

```
매우 중요하다고 생각한다. 
질좋은 차량의 상태 데이터들을 얻을 수 있다고 해도, 결국 주행 프로그래머가 잘못된 접근과 
해석을 통해 자율 주행을 구현한다면, 아무리 뛰어난 이론이 적용된 것이라 하더라도 무쓸모 하다고 생각했다.

이번 프로젝트에서 api 데이터들을 이용해서 전체 도로 정보를 표현할 때 뼈저리게 느낄 수 있었다.
도로 곡선 형태와 중앙선 위치 등의 정보를 가공하여 2차원 배열로 표현했을때, 
사소한 오차나 데이터에 대한 약간의 잘못된 해석만 첨가되기만 해도 도로의 형태가 실제 도로의 모습과 굉장한 차이가 났다.

실제의 경우 이 잘못된 2차원 배열형태의 도로정보에 기반한 주행이 이루어 졌을 경우,
얼마나 끔찍한 사고가 일어날지... 결과는 뻔했다.
```

<br>

<br>

#### 2. 중앙선 점을 어떤 방식으로 좌표로 표현할 수 있는가?

```
우리가 이용할 수 있는 api 데이터는 단순하게 위치 간 거리만 알 수 있을 뿐이었고, 
이것들을 정확히 좌표로 표현하여 2차원 배열로 찍어낸다는 것은 사실 불가능에 가까웠다고 생각했다.

그러나, 해당 정보들을 2차원 배열로 찍어 낼 수 만 있다면, 
장애물 극복이나, 도로의 곡선 형태에 따른 주행 제어 측면에서 정확도와 안정성에 큰 기여를 할 수 있다고 판단했다.
```

![KakaoTalk_20220821_183401198](https://user-images.githubusercontent.com/89068148/185785952-09ae9304-9911-41d3-a327-22c6cab131e3.jpg)

빨간지점은 각 중앙선 위의 way_points 점들이다. 

동시에 차량의 좌표에서의 상대적인 위치좌표를 구해야 할 대상이기도 했다.

따라서 얻어내야 할 정보는 **내 차량의 중심을 2차원 좌표로 나태내었을때, 그 좌표에서의  x값 차이와 y값 차이**이다.



![KakaoTalk_20220821_183401198_01](https://user-images.githubusercontent.com/89068148/185785953-74e12cd6-a7f8-4c58-b05c-2d8159b81abd.jpg)

먼저 차량 중심과 각 way_points들을 지점으로 하는 삼각형을 나타내었다.

여기서 `각 c`를 구하기 위한 그림인데, 먼저 점선으로 표현된 선은 차량의 방향각도를 중앙선으로 가져온 선이다.

따라서 **빨간점 사이의 직선이 중앙선**을 의미하고, **점선은 차량의 현재 진행각도를 표현한 직선**이다.

`angles` 배열은 api데이터 중 현재 차량위치를 중심으로 표현된 전방 20개 way_points에 대한 각도를 나타낸다.

따라서 그림에 표현된 것과 같이 `bo[i]`와 `각c` 사이의 각은 바로 다음 way_point의 `angles` 각에서 전 way_point지점의 `angles`각을 뺀 각과 같다.

따라서 `각c`의 경우 위 그림에 적힌 수식과 같다.

![KakaoTalk_20220821_204211216](https://user-images.githubusercontent.com/89068148/185789419-9d051ec6-89b7-4ff7-9ceb-ac9304c36e39.jpg)

여기서 `points` 배열은 api데이터중 `distance_to_way_points` 를 의미한다.

이번엔 `각A`를 구할 차례이다.

삼각형에서 **한 각과 마주보는 변의 길이의 비율은 모든 꼭지점 각에서 동일**하다.

따라서 구하려는 `각A`는 그림과 같이 표현할 수 있다.

  

![KakaoTalk_20220821_183401198_03](https://user-images.githubusercontent.com/89068148/185785956-16f7dfcf-0aeb-4e84-8a79-6a6980e2ad92.jpg)

따라서 `way_points`(중앙선 점) 들을 삼각형의 꼭지점으로 하고, 

반대쪽 차량의 중심인 `ts`의 각도를 구할 수 있었다.

위 그림에서 `ts`지점의 각도는 앞서 구한 `각c`,  `각a`를 이용해서 구할 수 있다.



![KakaoTalk_20220821_183401198_04](https://user-images.githubusercontent.com/89068148/185785946-296cbf6d-e971-451e-acbe-bf62bc51fd2d.jpg)

앞서 구한 방식으로 다른 모든 중앙점들의  경우에도 

`way_points` 에 대한 차량의 각도를 나타낼 수 있다.

![KakaoTalk_20220821_183401198_05](https://user-images.githubusercontent.com/89068148/185785947-d8f47e11-44b2-46b9-a24b-1dbf6f993be0.jpg)

사슬처럼 연계된 방식이다. 

앞서 구한 삼각형 윗 각은 다음 계산시, `bo[i]`로 표현할 수 있고, 

그림처럼 새로운 `각c`를 구할 수 있다.

![KakaoTalk_20220821_183401198_06](https://user-images.githubusercontent.com/89068148/185785949-f9cb23cc-d539-4800-91d3-f8aae21a0e15.jpg)

그림처럼, 앞서 구한 각의 누적합으로 다음 각을 표현하는 방식이다.



![KakaoTalk_20220821_183401198_07](https://user-images.githubusercontent.com/89068148/185790154-b5aaf787-96a5-42a9-b3f0-a0dcfbd0ea58.jpg)

따라서 우리가 필요한 중심점`way_point`의 좌표를 구하기 위해선, 

그림처럼 각의 누적합으로 삼각형에서 차량쪽의 각을 표현한다.

따라서 우리가 구하려는 중앙선 점들 중 하나를 `way[2]` 라고 예시를 들었을때, 

좌표의 경우 차량 중심점에서 x값이 `points[3] X cos(a + b + r)` 만큼 음수로 떨어져 있고, 

y값이 `points[3] X sin(a + b + r)` 만큼 떨어져 있다고 볼 수 있다.

<br>

<br>

#### 3. 도로 정보 및 장애물 표현하기

<br>

<br>

# 3. 2차원 MAP 기반, 장애물 극복 경로 찾기

<br>

#### 1차 시도 : 장애물 기반으로, 가능한 경로 수집

<br>

#### 2차 시도 : 최소 각 경로 찾기

<br>

#### 이슈 1 : 점으로 표현된 장애물 정보는 실제 크기를 반영하는가 ?

<br>

#### 이슈 2 : 차량각도가 항상 전방 수직으로 표현되는게 맞는가 ?

<br>

<br>

# 4. 발생한 치명적인 문제와 해결방안

<br>

#### 받아오는 API 값이 튄다.

<br>

#### 도로정보가 곡선일때, 왜곡된다.

<br>

<br>

# 5. 새로운 접근방법 : to_middle 기반

